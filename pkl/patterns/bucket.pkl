import "../cloudformation.pkl" as cfn
import "../aws/s3/bucket.pkl" as bucket
import "../aws/iam/rolepolicy.pkl" as rolepolicy
import "../aws/iam/role.pkl" as role

// An experimental pattern to create an S3 bucket that passes typical compliance checks.

open class SecureBucket extends bucket.Bucket {
    Metadata = new Mapping {
        ["Comment"] = "Records access logs for the main bucket"
        ["checkov"] {
            skip = new Listing {
                new {
                    comment = "This is the log bucket"
                    id = "CKV_AWS_18"
                }
            }
        }
        ["guard"] {
            SuppressedRules = new Listing {
                "S3_BUCKET_LOGGING_ENABLED"
                "S3_BUCKET_REPLICATION_ENABLED"
            }
        }
    }
                
    BucketEncryption {
        ServerSideEncryptionConfiguration {
            new {
                ServerSideEncryptionByDefault {
                    SSEAlgorithm = "AES256"
                }
            }
        }
    }

    ObjectLockConfiguration {
        ObjectLockEnabled = "Enabled"
        Rule {
            DefaultRetention {
                Mode = "COMPLIANCE"
                Years = 1
            }
        }
    }

    ObjectLockEnabled = true

    PublicAccessBlockConfiguration {
        BlockPublicAcls = true
        BlockPublicPolicy = true
        IgnorePublicAcls = true
        RestrictPublicBuckets = true
    }

    VersioningConfiguration {
        Status = "Enabled"
    }
}

// This is the only way I could think of to emit more than one resource
function resources(appName: String, logicalId: String): Mapping<String, cfn.Resource> = new Mapping {

    [logicalId] = new SecureBucket {
        BucketName = cfn.Sub("\(appName)-${AWS::Region}-${AWS::AccountId}")
        ObjectLockEnabled = false
        ObjectLockConfiguration = null
        LoggingConfiguration {
            DestinationBucketName = cfn.Ref("Log\(logicalId)")
        }
        ReplicationConfiguration {
            Role = cfn.GetAtt(logicalId + "ReplicationRole", "Arn")
            Rules {
                new {
                    Destination {
                        Bucket = cfn.GetAtt("Replica\(logicalId)", "Arn")
                    }
                    Status = "Enabled"
                }
            }
        }
        VersioningConfiguration {
            Status = "Enabled"
        }
    }

    ["Log" + logicalId] = new SecureBucket {
        BucketName = cfn.Sub("\(appName)-logs-${AWS::Region}-${AWS::AccountId}")

    }

    ["Replica" + logicalId] = new SecureBucket {
        BucketName = cfn.Sub("\(appName)-replicas-${AWS::Region}-${AWS::AccountId}")
        ObjectLockEnabled = false
        ObjectLockConfiguration = null
    }

    [logicalId + "ReplicationPolicy"] = new rolepolicy.RolePolicy {
        PolicyDocument {
            Statement = new Listing {
                new {
                    Action = new Listing {
                        "s3:GetReplicationConfiguration"
                        "s3:ListBucket"
                    }
                    Effect = "Allow"
                    Resource = cfn.Sub("arn:aws:s3:::\(appName)-${AWS::Region}-${AWS::AccountId}")
                }
                new {
                    Action {
                        "s3:GetObjectVersionForReplication"
                        "s3:GetObjectVersionAcl"
                        "s3:GetObjectVersionTagging"
                    }
                    Effect = "Allow"
                    Resource = cfn.Sub("arn:aws:s3:::\(appName)-${AWS::Region}-${AWS::AccountId}/*")
                }
                new {
                    Action {
                        "s3:ReplicateObject"
                        "s3:ReplicateDelete"
                        "s3:ReplicationTags"
                    }
                    Effect = "Allow"
                    Resource = cfn.Sub("arn:aws:s3:::\(appName)-replicas-${AWS::Region}-${AWS::AccountId}/*")
                }
            }
            Version = "2012-10-17"
        }
        PolicyName = "bucket-replication-policy"
        RoleName = cfn.Ref(logicalId + "ReplicationRole")
    }

    [logicalId + "ReplicationRole"] = new role.Role {
        AssumeRolePolicyDocument {
            Statement = new Listing {
                new {
                    Action = new Listing {
                        "sts:AssumeRole"
                    }
                    Effect = "Allow"
                    Principal {
                        Service = new Listing {
                            "s3.amazonaws.com"
                        }
                    }
                }
            }
            Version = "2012-10-17"
          }
          Path = "/"
    }
}

