Description: |
  This module creates a bucket that will pass cfn_nag checks by 
  configuring common best practices like encryption and logging.
  This is a rain module, which allows for existing resources to 
  be extended, similar to a sub-class in an object oriented language.

Extends: AWS::S3::Bucket

# New properties that the user can set
AdditionalProperties:

  LogBucketName:
    Type: String
    Description: The name of the log bucket

Metadata:
  Comment: A bucket that will pass cfn_nag checks
  cfn_nag:
    rules_to_suppress:
      - id: W51
        reason: "Will be added by the consumer"
DeletionPolicy: Retain
UpdateReplacePolicy: Retain

# Inherits all properties of a regular bucket
# The user can override any of these defaults in the template that uses this module
Properties:
  LoggingConfiguration:
    DestinationBucketName: !Ref LogBucket
  BucketEncryption:
    ServerSideEncryptionConfiguration:
      - ServerSideEncryptionByDefault:
         SSEAlgorithm: AES256
  VersioningConfiguration:
    Status: Enabled
  PublicAccessBlockConfiguration:
    BlockPublicAcls: true
    BlockPublicPolicy: true
    IgnorePublicAcls: true
    RestrictPublicBuckets: true
  Tags:
    - Key: test-tag
      Value: test-value1

# Additional resources to be added to the template

Resources:
  
  LogBucket:
    Type: AWS::S3::Bucket
    Metadata:
      Comment: This bucket records access logs for MyBucket
      cfn_nag:
        rules_to_suppress:
          - id: W35
            reason: "This is the log bucket"
          - id: W51
            reason: "Will be added by the consumer"
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      BucketName: !Ref LogBucketName
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true


